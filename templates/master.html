<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Punleu</title>
  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body style="background-color:#f9f5f0; font-family:Poppins, sans-serif; color:#4b2e2e;">
<div id="app">
  <div class="container-fluid p-0 m-0">
    <nav class="navbar navbar-expand-lg"
         style="background-color:#6f4e37; border-bottom:3px solid #4b2e2e;">
      <a class="navbar-brand"
         href="/"
         style="color:#ffffff; font-weight:bold; font-size:1.5rem;">
         Punleu
      </a>
      <button class="navbar-toggler" type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent"
              aria-expanded="false"
              aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto">
          <li class="nav-item active">
            <a class="nav-link"
               href="/"
               style="color:#f9f5f0; font-weight:500;">
               Catalog
            </a>
          </li>
          <li class="nav-item active">
            <a class="nav-link"
               href="/support"
               style="color:#f9f5f0; font-weight:500;">
               Support
            </a>
          </li>
        </ul>
        <input class="form-control me-2"
               type="search"
               placeholder="Category, Title"
               aria-label="Search"
               style="border-radius:30px; border:1px solid #a17c5b;" />
        <a href="/cart"
           class="btn btn-outline-success"
           type="button"
           style="border-radius:30px; border-color:#f9f5f0; color:#f9f5f0;">
          Cart([[ cart_list.length ]])
        </a>
      </div>
    </nav>
  </div>

  <div class="container" style="padding-top:2rem; padding-bottom:2rem;">
    {% block main_content %}{% endblock %}
  </div>
</div>

{% include "script.html" %}

<script>
const { createApp, ref, computed, onMounted } = Vue;

createApp({
  delimiters: ['[[', ']]'],
  setup() {
    const cart_list = ref(JSON.parse(localStorage.getItem('cart') ?? '[]'));
    const cartCount = computed(() =>
      cart_list.value.reduce((total, item) => total + (item.qty || 1), 0)
    );

    const searchQuery = ref('');
    const priceLimit = ref(500);
    const selected_product = ref({});
    const quantity = ref(1);

    const products = ref({{ products|default([])|tojson|safe }});
    const product = ref({{ product|default({})|tojson|safe }});

    const subtotal = computed(() =>
      cart_list.value.reduce((sum, item) => sum + item.price * item.qty, 0).toFixed(2)
    );
    const shipping = computed(() =>
      cart_list.value.length > 0 ? 5.99 : 0
    );
    const tax = computed(() =>
      (parseFloat(subtotal.value) * 0.1).toFixed(2)
    );
    const total = computed(() =>
      (parseFloat(subtotal.value) + shipping.value + parseFloat(tax.value)).toFixed(2)
    );

    const filteredProducts = computed(() =>
      products.value.filter(p =>
        p.title.toLowerCase().includes(searchQuery.value.toLowerCase()) &&
        p.price <= priceLimit.value
      )
    );

    const addToCart = (item = product.value) => {
      if (quantity.value < 1) {
        alert('Quantity must be at least 1');
        return;
      }

      const existing = cart_list.value.find(p => p.id === item.id);
      if (existing) {
        existing.qty += quantity.value;
      } else {
        cart_list.value.push({ ...item, qty: quantity.value });
      }
      localStorage.setItem('cart', JSON.stringify(cart_list.value));

      Swal.fire({
        icon: 'success',
        title: 'Added to Cart',
        text: `${item.name} x${quantity.value} added.`,
        timer: 1200,
        showConfirmButton: false
      });
    };

    const removeCartItem = (index) => {
      Swal.fire({
        title: 'Are you sure?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, remove it!',
        cancelButtonText: 'Cancel',
      }).then(result => {
        if (result.isConfirmed) {
          cart_list.value.splice(index, 1);
          localStorage.setItem('cart', JSON.stringify(cart_list.value));
        }
      });
    };

    const increaseQty = (item) => {
      if (item.qty < 10) {
        item.qty++;
        localStorage.setItem('cart', JSON.stringify(cart_list.value));
      }
    };

    const decreaseQty = (item, index) => {
      if (item.qty > 1) {
        item.qty--;
        localStorage.setItem('cart', JSON.stringify(cart_list.value));
      } else {
        Swal.fire({
          title: 'Are you sure?',
          text: 'This will remove the item from your cart.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, remove it!',
          cancelButtonText: 'Cancel',
        }).then(result => {
          if (result.isConfirmed) {
            cart_list.value.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart_list.value));
          }
        });
      }
    };

    const showProductDetail = (p) => {
      selected_product.value = p;
      $('#productModal').modal('show');
    };

    const isCartModalVisible = ref(false);
    const showCartModal = () => {
      isCartModalVisible.value = true;
    };
    const proceedToPurchase = () => {
      isCartModalVisible.value = false;
      window.location.href = "/cart";
    };

    const checkout = () => {
      window.location.href = "/checkout";
    };

    onMounted(() => {
      console.log("Cart loaded:", cart_list.value);
      const form = document.getElementById('checkoutForm');
      if (form) {
        form.addEventListener('submit', () => {
          const cartDataInput = document.getElementById('cart_data');
          if (cartDataInput) {
            cartDataInput.value = JSON.stringify(cart_list.value);
          }
        });
      } else {
        console.warn('checkoutForm not found in DOM!');
      }
    });

    return {
      cart_list,
      cartCount,
      products,
      product,
      selected_product,
      searchQuery,
      priceLimit,
      filteredProducts,
      quantity,
      addToCart,
      removeCartItem,
      increaseQty,
      decreaseQty,
      showProductDetail,
      subtotal,
      shipping,
      tax,
      total,
      isCartModalVisible,
      showCartModal,
      proceedToPurchase,
      checkout
    };
  }
}).mount('#app');
</script>
</body>
</html>
